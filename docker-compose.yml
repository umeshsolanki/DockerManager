services:
  server:
    image: docker-manager-server:${BUILD_NUMBER}
    container_name: docker-manager
    network_mode: host
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - TZ=Asia/Kolkata
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /sys/class/power_supply/BAT0:/sys/class/power_supply/BAT0
      - ./data:/app/data
      - /home:/home
      - /usr:/main:ro
      - /var/log:/host/var/log:ro

  proxy:
    build:
      context: .
      dockerfile: Dockerfile.proxy
    image: docker-manager-proxy:latest
    container_name: docker-manager-proxy
    network_mode: host
    restart: unless-stopped
    environment:
      - TZ=Asia/Kolkata
    volumes:
      - ./data/nginx/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf:ro
      - ./data/nginx/zones.conf:/etc/nginx/zones.conf:ro
      - ./data/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./data/nginx/logs:/usr/local/openresty/nginx/logs
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
      - ./data/certs:/etc/nginx/custom_certs:ro
    depends_on:
      - server
    command: /usr/local/openresty/bin/openresty -g 'daemon off;'

  certbot:
    image: certbot/certbot
    container_name: docker-manager-certbot
    environment:
      - TZ=Asia/Kolkata
    volumes:
      - ./data/certbot:/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --config-dir /certbot/conf --work-dir /certbot/work --logs-dir /certbot/logs; sleep 12h & wait $${!}; done'"

  james:
    image: apache/james:jpa-latest
    container_name: docker-manager-james
    hostname: james.local
    ports:
      - "25:25"     # SMTP
      - "143:143"   # IMAP
      - "465:465"   # SMTPS
      - "587:587"   # Submission
      - "993:993"   # IMAPS
      - "8001:8000" # WebAdmin API
    volumes:
      - ./data/james/conf:/root/conf
      - ./data/james/var:/root/var
    restart: unless-stopped
    environment:
      - TZ=Asia/Kolkata

  client:

    image: docker-manager-client:${BUILD_NUMBER}
    container_name: docker-manager-client
    ports:
      - "86:80"
    restart: unless-stopped
    environment:
      - TZ=Asia/Kolkata

