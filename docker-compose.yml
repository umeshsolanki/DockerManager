services:
  server:
    image: docker-manager-server:${BUILD_NUMBER}
    container_name: docker-manager
    network_mode: host
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - TZ=Asia/Kolkata
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /sys/class/power_supply/BAT0:/sys/class/power_supply/BAT0
      - docker-manager-storage:/app/data
      - /home:/home
      - /var/log:/host/var/log:ro
      - /usr/bin/last:/host/usr/bin/last:ro
      - ./nginx/conf.d:/usr/local/openresty/nginx/conf/conf.d
      - ./nginx/logs:/usr/local/openresty/nginx/logs
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot

  proxy:
    image: openresty/openresty:alpine
    container_name: docker-manager-proxy
    network_mode: host
    restart: unless-stopped
    environment:
      - TZ=Asia/Kolkata
    volumes:
      - ./nginx/conf.d:/usr/local/openresty/nginx/conf/conf.d:ro
      - ./nginx/logs:/usr/local/openresty/nginx/logs
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    depends_on:
      - server

  certbot:
    image: certbot/certbot
    container_name: docker-manager-certbot
    environment:
      - TZ=Asia/Kolkata
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done'"

  client:
    image: docker-manager-client:${BUILD_NUMBER}
    container_name: docker-manager-client
    ports:
      - "86:80"
    restart: unless-stopped
    environment:
      - TZ=Asia/Kolkata

volumes:
  docker-manager-storage:
