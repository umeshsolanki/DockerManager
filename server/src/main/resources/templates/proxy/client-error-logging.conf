# Client Error Mirroring (4xx)
# This captures common 4xx errors and mirrors them to the security backend
error_page 400 401 404 405 408 413 414 431 451 = @client_error_mirror;

location @client_error_mirror {
    internal;
    ${clientErrorLoggingDirectives}
    mirror /_client_error_mirror;
    
    # Use explicit returns as some Nginx versions don't allow variables in 'return'
    if ($status = 400) { return 400; }
    if ($status = 401) { return 401; }
    if ($status = 403) { return 403; }
    if ($status = 404) { return 404; }
    if ($status = 405) { return 405; }
    if ($status = 408) { return 408; }
    if ($status = 413) { return 413; }
    if ($status = 414) { return 414; }
    if ($status = 429) { return 429; }
    if ($status = 431) { return 431; }
    if ($status = 451) { return 451; }
    
    return 400; # Fallback
}

location = /_client_error_mirror {
    internal;
    mirror_request_body off;
    proxy_set_header X-Mirror-Status $status;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_pass http://${dangerProxyHost}/security/mirror${request_uri};
}
