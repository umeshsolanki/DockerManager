# Security channel: suspicious traffic only. rsyslog reads this file and forwards to /mirror/security.
# Requires: security-maps.conf (defines $log_access, $log_security, $violation_reason, $redacted_query).

# Log format for analysis: key=value, one line per request (easy to parse and grep)
log_format security_analysis
    'time=$time_iso8601 '
    'remote_addr=$remote_addr '
    'method=$request_method '
    'uri=$request_uri '
    'redacted_args=$redacted_query '
    'status=$status '
    'violation_reason=$violation_reason '
    'http_user_agent="$http_user_agent" '
    'referer="$http_referer" '
    'host=$host '
    'request_time=$request_time '
    'bytes_sent=$bytes_sent';

# Dedicated security log: only when $log_security == 1 (status >= 400 or explicit violation)
# Buffered to avoid blocking worker; values from settings (logBufferSizeKb, logFlushIntervalSeconds)
access_log /usr/local/openresty/nginx/logs/security.log security_analysis if=$log_security buffer=${logBufferSizeKb}k flush=${logFlushIntervalSeconds}s;
