# Security maps: violation reasons + log split (normal → access.log, suspicious → security.log → rsyslog /mirror/security)

map $request_uri $security_violation_reason {
    default "";
    ${pathViolations}
}

map $http_user_agent $ua_violation_reason {
    default "";
    ${uaViolations}
}

map "$security_violation_reason:$ua_violation_reason" $explicit_violation_reason {
    "~^(.+):" $1;
    "~^:(.+)" $1;
    default "";
}

map $status $status_reason {
    "~^429" "rate_limit_exceeded";
    "~^4"   "client_error";
    "~^5"   "server_error";
    default "unknown";
}

map $explicit_violation_reason $violation_reason {
    ""      $status_reason;
    default $explicit_violation_reason;
}

map $status $expected_status {
    default $status;
}

map $status $status_100_399 {
    ~^[123] 1;
    default 0;
}

map "$status_100_399:$explicit_violation_reason" $log_access {
    "1:" 1;
    default 0;
}

map "$status_100_399:$explicit_violation_reason" $log_security {
    "~^0:"  1;
    "~:.+" 1;
    default 0;
}

map $args $redacted_query {
    default $args;
    ~^(.*)token=[^&]*(.*)$ $1token=REDACTED$2;
    ~^(.*)password=[^&]*(.*)$ $1password=REDACTED$2;
    ~^(.*)api_key=[^&]*(.*)$ $1api_key=REDACTED$2;
    ~^(.*)apikey=[^&]*(.*)$ $1apikey=REDACTED$2;
}

${globalBurstZone}
