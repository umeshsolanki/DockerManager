# Forward nginx security logs to /security/mirror
# Copy to /etc/rsyslog.d/01-nginx-mirror.conf (01 = load early, before any "stop")
#
# Two modes:
# A) Syslog mode: Nginx sends to rsyslog (proxyRsyslogEnabled=true). Tag=nginx_main_sec.
# B) File mode: imfile reads security.log (proxyRsyslogEnabled=false). Use the imfile block below.

module(load="omhttp")

template(name="mirrorBody" type="string" string="%msg%\n")

# === A) Forward logs received via UDP/TCP (nginx sends directly to syslog) ===
# Nginx uses tag=nginx_main_sec for security_json format
if ($programname == "nginx_main_sec" or $syslogtag startswith "nginx_main_sec") then {
    action(type="omhttp"
           server="127.0.0.1"
           serverport="8080"
           restpath="security/mirror"
           template="mirrorBody"
           httpheaders=["Content-Type: application/json"]
           usehttps="off")
    # Do not stop - let existing rules also write to file
}

# === B) File-only mode: read security.log when nginx writes to file only ===
# Uncomment when proxyRsyslogEnabled=false (nginx writes to file, no syslog)
# module(load="imfile" mode="inotify")
# input(type="imfile"
#       File="/usr/local/openresty/nginx/logs/security.log"
#       Tag="nginx_sec_file"
#       Severity="notice"
#       Facility="local0"
#       deleteStateOnFileDelete="on"
#       ruleset="mirrorForward")
# ruleset(name="mirrorForward") {
#     action(type="omhttp"
#            server="127.0.0.1"
#            serverport="8080"
#            restpath="security/mirror"
#            template="mirrorBody"
#            httpheaders=["Content-Type: application/json"]
#            usehttps="off")
# }
