services:
  # Mailcow-like setup using Postfix + Dovecot + Roundcube
  # Using alternative ports to avoid conflicts with James
  
  mailcow-postgres:
    image: postgres:16-alpine
    container_name: docker-manager-mailcow-postgres
    hostname: mailcow-postgres
    environment:
      POSTGRES_DB: mailcow
      POSTGRES_USER: mailcow
      POSTGRES_PASSWORD: mailcow
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ${mailcowPath}/postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mailcow"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mailcow-network

  mailcow-redis:
    image: redis:7-alpine
    container_name: docker-manager-mailcow-redis
    hostname: mailcow-redis
    volumes:
      - ${mailcowPath}/redis-data:/data
    restart: unless-stopped
    command: redis-server --appendonly yes
    networks:
      - mailcow-network

  # Postfix + Dovecot mail server (Mailcow alternative)
  # Using tvial/docker-mailserver which is similar to Mailcow
  mailcow-mailserver:
    image: docker.io/mailserver/docker-mailserver:latest
    container_name: docker-manager-mailcow-mailserver
    hostname: mailcow.local
    depends_on:
      mailcow-postgres:
        condition: service_healthy
      mailcow-redis:
        condition: service_started
    ports:
      - "2525:25"     # SMTP (alternative to James port 25)
      - "1143:143"    # IMAP (alternative to James port 143)
      - "4650:465"    # SMTPS (alternative to James port 465)
      - "2587:587"    # Submission (alternative to James port 587)
      - "1993:993"    # IMAPS (alternative to James port 993)
    volumes:
      - ${mailcowPath}/mail-data:/var/mail
      - ${mailcowPath}/mail-state:/var/mail-state
      - ${mailcowPath}/config:/tmp/docker-mailserver
      - ${mailcowPath}/config/postfix-accounts.cf:/tmp/docker-mailserver/postfix-accounts.cf
      - ${mailcowPath}/config/postfix-virtual.cf:/tmp/docker-mailserver/postfix-virtual.cf
    environment:
      - ENABLE_SPAMASSASSIN=1
      - ENABLE_CLAMAV=1
      - ENABLE_FAIL2BAN=1
      - ENABLE_POSTGREY=1
      - ONE_DIR=1
      - DMS_DEBUG=0
      - TZ=Asia/Kolkata
    restart: unless-stopped
    networks:
      - mailcow-network

  # Roundcube Webmail (similar to Mailcow's webmail)
  mailcow-webmail:
    image: roundcube/roundcubemail:latest
    container_name: docker-manager-mailcow-webmail
    hostname: mailcow-webmail
    depends_on:
      - mailcow-mailserver
      - mailcow-postgres
    ports:
      - "8080:80"     # Web UI HTTP
      - "8443:443"    # Web UI HTTPS
    volumes:
      - ${mailcowPath}/webmail:/var/www/html
      - ${mailcowPath}/webmail-config:/var/www/html/config
    environment:
      - ROUNDCUBEMAIL_DEFAULT_HOST=mailcow-mailserver
      - ROUNDCUBEMAIL_DEFAULT_PORT=143
      - ROUNDCUBEMAIL_SMTP_SERVER=mailcow-mailserver
      - ROUNDCUBEMAIL_SMTP_PORT=587
      - ROUNDCUBEMAIL_DB_TYPE=pgsql
      - ROUNDCUBEMAIL_DB_HOST=mailcow-postgres
      - ROUNDCUBEMAIL_DB_NAME=mailcow
      - ROUNDCUBEMAIL_DB_USER=mailcow
      - ROUNDCUBEMAIL_DB_PASSWORD=mailcow
      - TZ=Asia/Kolkata
    restart: unless-stopped
    networks:
      - mailcow-network

networks:
  mailcow-network:
    driver: bridge

