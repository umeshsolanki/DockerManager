def VERSION = ""

pipeline {
    agent any

    stages {
        stage('Initialize') {
            steps {
                script {
                    // Extract version from server's build.gradle.kts
                    VERSION = sh(script: "./gradlew :server:properties -q | grep '^version:' | awk '{print \$2}'", returnStdout: true).trim()
                    echo "Building Version: ${VERSION}"
                }
            }
        }
//         stage('Test') {
//             steps {
//                 sh './gradlew test'
//             }
//         }

        stage('Build FatJar') {
            steps {
                // Use shadowJar task to build the FatJar
                sh './gradlew clean'
                sh './gradlew :server:shadowJar'
            }
        }

        stage('Build Web UI Image') {
            steps {
                script {
                    // Build the web-app docker image with semantic version
                    sh "docker build -t docker-manager-client:${VERSION} --label jenkins_build_id=${env.BUILD_ID} -f Dockerfile.client ."
                }
            }
        }

        stage('Deploy Server (Systemd)') {
            environment {
                BUILD_NUMBER = "${VERSION}"
            }
            steps {
                // Copy the built jar to /opt/docker-manager
                sh 'mkdir -p /opt/docker-manager'
                sh 'cp -f server/build/libs/server-all.jar /opt/docker-manager/server-all.jar'
                
                // Copy service files
                sh 'cp docker-manager.service /opt/docker-manager/docker-manager.service'
                sh 'cp docker-manager.path /opt/docker-manager/docker-manager.path'
                sh 'cp docker-manager-restart.service /opt/docker-manager/docker-manager-restart.service'
                sh 'cp setup-services.sh /opt/docker-manager/setup-services.sh'
                
                // Run setup script
               // sh 'chmod +x /opt/docker-manager/setup-services.sh'
               // sh '/opt/docker-manager/setup-services.sh'
                
                // Start/Restart the service
               // sh 'systemctl restart docker-manager.service'
            }
        }

        stage('Deploy Web UI Container') {
            environment {
                BUILD_NUMBER = "${VERSION}"
            }
            steps {
                script {
                    def composeCmd = ""
                    if (sh(script: "docker compose version", returnStatus: true) == 0) {
                        composeCmd = "docker compose"
                    } else {
                        composeCmd = "docker-compose"
                    }
                    sh "BUILD_NUMBER=${env.BUILD_NUMBER} ${composeCmd} -f docker-manager-ui.yml up -d --remove-orphans"
                }
            }
        }
    }
    
    post {
        always {
            script {
                // Cleanup old containers and images from previous builds
                sh "docker ps -a --filter 'label=jenkins_build_id' --format '{{.ID}}' | xargs -r docker inspect --format '{{.Id}} {{index .Config.Labels \"jenkins_build_id\"}}' | grep -v '${env.BUILD_ID}' | awk '{print \$1}' | xargs -r docker rm -f || true"
                sh "docker images --filter 'label=jenkins_build_id' --format '{{.ID}}' | xargs -r docker inspect --format '{{.Id}} {{index .Config.Labels \"jenkins_build_id\"}}' | grep -v '${env.BUILD_ID}' | awk '{print \$1}' | xargs -r docker rmi -f || true"
            }
            cleanWs()
        }
    }
}
