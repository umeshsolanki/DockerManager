def VERSION = ""

pipeline {
    agent any

    stages {
        stage('Initialize') {
            steps {
                script {
                    // Extract version from server's build.gradle.kts
                    VERSION = sh(script: "./gradlew :server:properties -q | grep '^version:' | awk '{print \$2}'", returnStdout: true).trim()
                    echo "Building Version: ${VERSION}"
                }
            }
        }
//         stage('Test') {
//             steps {
//                 sh './gradlew test'
//             }
//         }

        stage('Build Web UI') {
            steps {
                dir('web-app') {
                    sh 'npm install'
                    sh 'npm run build'
                }
                script {
                    // Create directory for static resources in server module
                    sh 'mkdir -p server/src/main/resources/ui'
                    // Clear existing resources if any
                    sh 'rm -rf server/src/main/resources/ui/*'
                    // Copy built UI to server resources
                    sh 'cp -r web-app/out/* server/src/main/resources/ui/'
                }
            }
        }

        stage('Build FatJar') {
            steps {
                // Use shadowJar task to build the FatJar
                sh './gradlew clean'
                sh './gradlew :server:shadowJar'
            }
        }

        stage('Deploy Server (Systemd)') {
            environment {
                BUILD_NUMBER = "${VERSION}"
            }
            steps {
                // Copy the built jar to /opt/docker-manager
                sh 'mkdir -p /opt/docker-manager'
                sh 'cp -f server/build/libs/server-all.jar /opt/docker-manager/server-all.jar'
                
                // Copy service files
                sh 'cp docker-manager.service /opt/docker-manager/docker-manager.service'
                sh 'cp docker-manager.path /opt/docker-manager/docker-manager.path'
                sh 'cp docker-manager-restart.service /opt/docker-manager/docker-manager-restart.service'
                sh 'cp setup-services.sh /opt/docker-manager/setup-services.sh'
                
                // Run setup script
               // sh 'chmod +x /opt/docker-manager/setup-services.sh'
               // sh '/opt/docker-manager/setup-services.sh'
                
                // Start/Restart the service
               // sh 'systemctl restart docker-manager.service'
            }
        }
    }
    
    post {
        always {
            script {
                // Cleanup old containers and images from previous builds
                sh "docker ps -a --filter 'label=jenkins_build_id' --format '{{.ID}}' | xargs -r docker inspect --format '{{.Id}} {{index .Config.Labels \"jenkins_build_id\"}}' | grep -v '${env.BUILD_ID}' | awk '{print \$1}' | xargs -r docker rm -f || true"
                sh "docker images --filter 'label=jenkins_build_id' --format '{{.ID}}' | xargs -r docker inspect --format '{{.Id}} {{index .Config.Labels \"jenkins_build_id\"}}' | grep -v '${env.BUILD_ID}' | awk '{print \$1}' | xargs -r docker rmi -f || true"
            }
            cleanWs()
        }
    }
}
